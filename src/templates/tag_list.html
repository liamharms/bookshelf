{% extends "base.html" %}
{% from "macros.html" import render_tree %}

{% block title %}Tags - {{ super() }}{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title">Tags</h1>
        <a href="{{ url_for('tags.tag_add') }}" class="button button-primary">Add New Tag</a>
        <!-- Dynamic Search -->
<div class="search-form">
    <div class="search-container">
        <input type="text" id="tagsSearchInput" class="search-input" placeholder="Search tags by label or description..." aria-label="Search">
        <button class="search-button" type="button">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        </button>
    </div>
</div>

<!-- Loading indicator -->
<div id="tagsLoadingIndicator" class="loading-indicator" style="display: none;">
    <div class="loading-spinner"></div>
    <span>Searching...</span>
</div>

<!-- Results count -->
<div id="tagsResultsCount" class="results-count" style="display: none;"></div>
    </div>

<div id="tagsResultsContainer">
{% if tags %}
    {% set root_tags = tags | selectattr('parent', 'equalto', none) | list %}
    <div id="originalTagsTree">
        {{ render_tree(root_tags, 'label', 'works', 'tags.tag_detail') }}
    </div>
{% else %}
<div class="alert-info">
    No tags found. <a href="{{ url_for('tags.tag_add') }}" class="alert-link">Add your first tag</a>.
</div>
{% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
    let tagsSearchTimeout;
    const tagsSearchInput = document.getElementById('tagsSearchInput');
    const tagsResultsContainer = document.getElementById('tagsResultsContainer');
    const tagsLoadingIndicator = document.getElementById('tagsLoadingIndicator');
    const tagsResultsCount = document.getElementById('tagsResultsCount');
    const originalTagsTree = document.getElementById('originalTagsTree');
    let originalTagsHtml = originalTagsTree ? originalTagsTree.innerHTML : '';

    function performTagsSearch(query) {
        if (query.trim() === '') {
            tagsResultsContainer.innerHTML = originalTagsTree ? 
                originalTagsHtml : 
                `<div class="alert-info">
                    No tags found. <a href="/tags/add" class="alert-link">Add your first tag</a>.
                </div>`;
            tagsResultsCount.style.display = 'none';
            return;
        }
        
        tagsLoadingIndicator.style.display = 'flex';
        
        fetch(`/api/search/tags?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displayTagsResults(data.tags, query);
            })
            .catch(error => {
                console.error('Tags search error:', error);
                tagsResultsContainer.innerHTML = `
                    <div class="alert-error">
                        <p>An error occurred while searching. Please try again.</p>
                    </div>
                `;
            })
            .finally(() => {
                tagsLoadingIndicator.style.display = 'none';
            });
    }

    function displayTagsResults(tags, query) {
        const count = tags.length;
        
        if (count > 0) {
            tagsResultsCount.innerHTML = `Found ${count} tag${count !== 1 ? 's' : ''}`;
            tagsResultsCount.style.display = 'block';
        } else {
            tagsResultsCount.style.display = 'none';
        }

        if (count === 0) {
            tagsResultsContainer.innerHTML = `
                <div class="alert-info">
                    No tags found matching "${query}".
                </div>
            `;
            return;
        }

        let html = '<div class="tree-container">';
        tags.forEach(tag => {
            const label = highlightText(tag.label || '', query);
            const description = tag.description ? highlightText(tag.description.substring(0, 100), query) : '';
            const workCount = tag.work_count || 0;
            
            html += `
                <div class="tree-item">
                    <div class="tree-content">
                        <a href="/tags/${tag.id}" class="tree-link">${label}</a>
                        <span class="tree-count">(${workCount} works)</span>
                    </div>
                    ${description ? `<div class="tree-description">${description}${tag.description.length > 100 ? '...' : ''}</div>` : ''}
                </div>
            `;
        });
        html += '</div>';

        tagsResultsContainer.innerHTML = html;
    }

    function highlightText(text, query) {
        if (!text || !query || typeof text !== 'string') return text || '';
        
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    tagsSearchInput.addEventListener('input', function() {
        const query = this.value;
        
        clearTimeout(tagsSearchTimeout);
        
        tagsSearchTimeout = setTimeout(() => {
            performTagsSearch(query);
        }, 300);
    });

    tagsSearchInput.focus();
</script>
{% endblock %}