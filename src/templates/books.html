{% extends "base.html" %}
{% from "macros.html" import work_card %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Books</h1>
    <a href="{{ url_for('books.book_add') }}" class="button button-primary">Add New Book</a>
</div>

<!-- Dynamic Search -->
<div class="search-form">
    <div class="search-container">
        <input type="text" id="booksSearchInput" class="search-input" placeholder="Search books by title, author, ISBN..." aria-label="Search">
        <button class="search-button" type="button">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        </button>
    </div>
</div>

<!-- Loading indicator -->
<div id="booksLoadingIndicator" class="loading-indicator" style="display: none;">
    <div class="loading-spinner"></div>
    <span>Searching...</span>
</div>

<!-- Results count -->
<div id="booksResultsCount" class="results-count" style="display: none;"></div>

<div class="overview-cards">
    <!-- Works card -->
    <div class="overview-card">
        <a href="{{ url_for('books.work_list') }}" class="overview-link">
            <div class="card">
                <div class="overview-content">
                    <div class="overview-text">
                        <h3 class="overview-title">View works</h3>
                        <p class="overview-subtitle">{{ works|length }} works</p>
                        <p class="overview-description">Recently added: [work title]</p>
                    </div>
                    <div class="overview-image">
                        <img src="{{ url_for('static', filename='img/book_placeholder.jpeg') }}" alt="Works">
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- Copies card -->
    <div class="overview-card">
        <a href="{{ url_for('books.copies_list') }}" class="overview-link">
            <div class="card">
                <div class="overview-content">
                    <div class="overview-text">
                        <h3 class="overview-title">View copies</h3>
                        <p class="overview-subtitle">{{ copies|length }} copies</p>
                        <p class="overview-description">Recently added: [copy title]</p>
                    </div>
                    <div class="overview-image">
                        <img src="{{ url_for('static', filename='img/book_placeholder.jpeg') }}" alt="Copies">
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<div id="booksResultsContainer">
{% if works %}
<div class="works-section">
    <h2 class="section-title">All Books</h2>
    <div class="book-grid" id="originalBooksGrid">
        {% for book in works %}
            {{ work_card(book) }}
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert-info">
    No works found. <a href="{{ url_for('books.book_add') }}" class="alert-link">Add your first book</a>.
</div>
{% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    let booksSearchTimeout;
    const booksSearchInput = document.getElementById('booksSearchInput');
    const booksResultsContainer = document.getElementById('booksResultsContainer');
    const booksLoadingIndicator = document.getElementById('booksLoadingIndicator');
    const booksResultsCount = document.getElementById('booksResultsCount');
    const originalBooksGrid = document.getElementById('originalBooksGrid');
    let originalBooksHtml = originalBooksGrid ? originalBooksGrid.innerHTML : '';

    function performBooksSearch(query) {
        if (query.trim() === '') {
            // Restore original content
            booksResultsContainer.innerHTML = originalBooksGrid ? 
                `<div class="works-section">
                    <h2 class="section-title">All Books</h2>
                    <div class="book-grid">${originalBooksHtml}</div>
                </div>` : 
                `<div class="alert-info">
                    No works found. <a href="/books/add" class="alert-link">Add your first book</a>.
                </div>`;
            booksResultsCount.style.display = 'none';
            return;
        }
        
        booksLoadingIndicator.style.display = 'flex';
        
        fetch(`/api/search/works?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displayBooksResults(data.works, query);
            })
            .catch(error => {
                console.error('Books search error:', error);
                booksResultsContainer.innerHTML = `
                    <div class="alert-error">
                        <p>An error occurred while searching. Please try again.</p>
                    </div>
                `;
            })
            .finally(() => {
                booksLoadingIndicator.style.display = 'none';
            });
    }

    function displayBooksResults(works, query) {
        const count = works.length;
        
        if (count > 0) {
            booksResultsCount.innerHTML = `Found ${count} work${count !== 1 ? 's' : ''}`;
            booksResultsCount.style.display = 'block';
        } else {
            booksResultsCount.style.display = 'none';
        }

        if (count === 0) {
            booksResultsContainer.innerHTML = `
                <div class="works-section">
                    <h2 class="section-title">Search Results</h2>
                    <div class="alert-info">
                        No books found matching "${query}".
                    </div>
                </div>
            `;
            return;
        }

        let html = '<div class="works-section"><h2 class="section-title">Search Results</h2><div class="book-grid">';
        works.forEach(work => {
            const authors = work.authors && work.authors.length > 0 ? 
                work.authors.map(a => highlightText(a, query)).join(', ') : '';
            const title = highlightText(work.title || '', query);
            const isbn = work.isbn ? highlightText(String(work.isbn), query) : '';
            
            html += `
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title">
                            <a href="/books/${work.id}">${title}</a>
                        </h3>
                        <div class="card-text">
                            ${authors ? `<p><strong>Authors:</strong> ${authors}</p>` : ''}
                            ${isbn ? `<p><strong>ISBN:</strong> ${isbn}</p>` : ''}
                            ${work.copies_count ? `<p><strong>Copies:</strong> ${work.copies_count}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div></div>';

        booksResultsContainer.innerHTML = html;
    }

    function highlightText(text, query) {
        if (!text || !query || typeof text !== 'string') return text || '';
        
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    booksSearchInput.addEventListener('input', function() {
        const query = this.value;
        
        clearTimeout(booksSearchTimeout);
        
        booksSearchTimeout = setTimeout(() => {
            performBooksSearch(query);
        }, 300);
    });

    booksSearchInput.focus();
</script>
{% endblock %}