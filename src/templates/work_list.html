{% extends "base.html" %}
{% from "macros.html" import work_card %}

{% block title %}Works - {{ super() }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Works</h1>
</div>

    <!-- Dynamic Search -->
<div class="search-form">
    <div class="search-container">
        <input type="text" id="worksSearchInput" class="search-input" placeholder="Search works by title, author, ISBN..." aria-label="Search">
        <button class="search-button" type="button">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        </button>
    </div>
</div>

<!-- Loading indicator -->
<div id="worksLoadingIndicator" class="loading-indicator" style="display: none;">
    <div class="loading-spinner"></div>
    <span>Searching...</span>
</div>

<!-- Results count -->
<div id="worksResultsCount" class="results-count" style="display: none;"></div>

<div id="worksResultsContainer">
{% if works %}
<div class="works-section">
    <h2 class="section-title">All Works</h2>
    <div class="book-grid" id="originalWorksGrid">
        {% for work in works %}
            {{ work_card(work) }}
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert-info">
    No works found. <a href="{{ url_for('books.work_add') }}" class="alert-link">Add your first work</a>.
</div>
{% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    let worksSearchTimeout;
    const worksSearchInput = document.getElementById('worksSearchInput');
    const worksResultsContainer = document.getElementById('worksResultsContainer');
    const worksLoadingIndicator = document.getElementById('worksLoadingIndicator');
    const worksResultsCount = document.getElementById('worksResultsCount');
    const originalWorksGrid = document.getElementById('originalWorksGrid');
    let originalWorksHtml = originalWorksGrid ? originalWorksGrid.innerHTML : '';

    function performWorksSearch(query) {
        if (query.trim() === '') {
            worksResultsContainer.innerHTML = originalWorksGrid ? 
                `<div class="works-section">
                    <h2 class="section-title">All Works</h2>
                    <div class="book-grid">${originalWorksHtml}</div>
                </div>` : 
                `<div class="alert-info">
                    No works found. <a href="/books/works/add" class="alert-link">Add your first work</a>.
                </div>`;
            worksResultsCount.style.display = 'none';
            return;
        }
        
        worksLoadingIndicator.style.display = 'flex';
        
        fetch(`/api/search/works?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displayWorksResults(data.works, query);
            })
            .catch(error => {
                console.error('Works search error:', error);
                worksResultsContainer.innerHTML = `
                    <div class="alert-error">
                        <p>An error occurred while searching. Please try again.</p>
                    </div>
                `;
            })
            .finally(() => {
                worksLoadingIndicator.style.display = 'none';
            });
    }

    function displayWorksResults(works, query) {
        const count = works.length;
        
        if (count > 0) {
            worksResultsCount.innerHTML = `Found ${count} work${count !== 1 ? 's' : ''}`;
            worksResultsCount.style.display = 'block';
        } else {
            worksResultsCount.style.display = 'none';
        }

        if (count === 0) {
            worksResultsContainer.innerHTML = `
                <div class="works-section">
                    <h2 class="section-title">Search Results</h2>
                    <div class="alert-info">
                        No works found matching "${query}".
                    </div>
                </div>
            `;
            return;
        }

        let html = '<div class="works-section"><h2 class="section-title">Search Results</h2><div class="book-grid">';
        works.forEach(work => {
            const authors = work.authors && work.authors.length > 0 ? 
                work.authors.map(a => highlightText(a, query)).join(', ') : '';
            const title = highlightText(work.title || '', query);
            const isbn = work.isbn ? highlightText(String(work.isbn), query) : '';
            
            html += `
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title">
                            <a href="/books/${work.id}">${title}</a>
                        </h3>
                        <div class="card-text">
                            ${authors ? `<p><strong>Authors:</strong> ${authors}</p>` : ''}
                            ${isbn ? `<p><strong>ISBN:</strong> ${isbn}</p>` : ''}
                            ${work.copies_count ? `<p><strong>Copies:</strong> ${work.copies_count}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div></div>';

        worksResultsContainer.innerHTML = html;
    }

    function highlightText(text, query) {
        if (!text || !query || typeof text !== 'string') return text || '';
        
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    worksSearchInput.addEventListener('input', function() {
        const query = this.value;
        
        clearTimeout(worksSearchTimeout);
        
        worksSearchTimeout = setTimeout(() => {
            performWorksSearch(query);
        }, 300);
    });

    worksSearchInput.focus();
</script>
{% endblock %}